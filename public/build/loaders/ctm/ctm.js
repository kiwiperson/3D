var CTM=CTM||{};CTM.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053},CTM.Flags={NORMALS:1},CTM.File=function(e){this.load(e)},CTM.File.prototype.load=function(e){this.header=new CTM.FileHeader(e),this.body=new CTM.FileBody(this.header),this.getReader().read(e,this.body)},CTM.File.prototype.getReader=function(){var e;switch(this.header.compressionMethod){case CTM.CompressionMethod.RAW:e=new CTM.ReaderRAW;break;case CTM.CompressionMethod.MG1:e=new CTM.ReaderMG1;break;case CTM.CompressionMethod.MG2:e=new CTM.ReaderMG2}return e},CTM.FileHeader=function(e){e.readInt32(),this.fileFormat=e.readInt32(),this.compressionMethod=e.readInt32(),this.vertexCount=e.readInt32(),this.triangleCount=e.readInt32(),this.uvMapCount=e.readInt32(),this.attrMapCount=e.readInt32(),this.flags=e.readInt32(),this.comment=e.readString()},CTM.FileHeader.prototype.hasNormals=function(){return this.flags&CTM.Flags.NORMALS},CTM.FileBody=function(e){var t=e.triangleCount*3,n=e.vertexCount*3,r=e.hasNormals()?e.vertexCount*3:0,i=e.vertexCount*2,s=e.vertexCount*4,o=0,u=new ArrayBuffer((t+n+r+i*e.uvMapCount+s*e.attrMapCount)*4);this.indices=new Uint32Array(u,0,t),this.vertices=new Float32Array(u,t*4,n),e.hasNormals()&&(this.normals=new Float32Array(u,(t+n)*4,r));if(e.uvMapCount){this.uvMaps=[];for(o=0;o<e.uvMapCount;++o)this.uvMaps[o]={uv:new Float32Array(u,(t+n+r+o*i)*4,i)}}if(e.attrMapCount){this.attrMaps=[];for(o=0;o<e.attrMapCount;++o)this.attrMaps[o]={attr:new Float32Array(u,(t+n+r+i*e.uvMapCount+o*s)*4,s)}}},CTM.FileMG2Header=function(e){e.readInt32(),this.vertexPrecision=e.readFloat32(),this.normalPrecision=e.readFloat32(),this.lowerBoundx=e.readFloat32(),this.lowerBoundy=e.readFloat32(),this.lowerBoundz=e.readFloat32(),this.higherBoundx=e.readFloat32(),this.higherBoundy=e.readFloat32(),this.higherBoundz=e.readFloat32(),this.divx=e.readInt32(),this.divy=e.readInt32(),this.divz=e.readInt32(),this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx,this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy,this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz},CTM.ReaderRAW=function(){},CTM.ReaderRAW.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},CTM.ReaderRAW.prototype.readIndices=function(e,t){e.readInt32(),e.readArrayInt32(t)},CTM.ReaderRAW.prototype.readVertices=function(e,t){e.readInt32(),e.readArrayFloat32(t)},CTM.ReaderRAW.prototype.readNormals=function(e,t){e.readInt32(),e.readArrayFloat32(t)},CTM.ReaderRAW.prototype.readUVMaps=function(e,t){var n=0;for(;n<t.length;++n)e.readInt32(),t[n].name=e.readString(),t[n].filename=e.readString(),e.readArrayFloat32(t[n].uv)},CTM.ReaderRAW.prototype.readAttrMaps=function(e,t){var n=0;for(;n<t.length;++n)e.readInt32(),t[n].name=e.readString(),e.readArrayFloat32(t[n].attr)},CTM.ReaderMG1=function(){},CTM.ReaderMG1.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},CTM.ReaderMG1.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length),CTM.restoreIndices(t,t.length)},CTM.ReaderMG1.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var n=new CTM.InterleavedStream(t,1);LZMA.decompress(e,e,n,n.data.length)},CTM.ReaderMG1.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length)},CTM.ReaderMG1.prototype.readUVMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32(),t[n].name=e.readString(),t[n].filename=e.readString(),e.readInt32();var r=new CTM.InterleavedStream(t[n].uv,2);LZMA.decompress(e,e,r,r.data.length)}},CTM.ReaderMG1.prototype.readAttrMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32(),t[n].name=e.readString(),e.readInt32();var r=new CTM.InterleavedStream(t[n].attr,4);LZMA.decompress(e,e,r,r.data.length)}},CTM.ReaderMG2=function(){},CTM.ReaderMG2.prototype.read=function(e,t){this.MG2Header=new CTM.FileMG2Header(e),this.readVertices(e,t.vertices),this.readIndices(e,t.indices),t.normals&&this.readNormals(e,t),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},CTM.ReaderMG2.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length);var r=this.readGridIndices(e,t);CTM.restoreVertices(t,this.MG2Header,r,this.MG2Header.vertexPrecision)},CTM.ReaderMG2.prototype.readGridIndices=function(e,t){e.readInt32(),e.readInt32();var n=new Uint32Array(t.length/3),r=new CTM.InterleavedStream(n,1);return LZMA.decompress(e,e,r,r.data.length),CTM.restoreGridIndices(n,n.length),n},CTM.ReaderMG2.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length),CTM.restoreIndices(t,t.length)},CTM.ReaderMG2.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var n=new CTM.InterleavedStream(t.normals,3);LZMA.decompress(e,e,n,n.data.length);var r=CTM.calcSmoothNormals(t.indices,t.vertices);CTM.restoreNormals(t.normals,r,this.MG2Header.normalPrecision)},CTM.ReaderMG2.prototype.readUVMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32(),t[n].name=e.readString(),t[n].filename=e.readString();var r=e.readFloat32();e.readInt32();var i=new CTM.InterleavedStream(t[n].uv,2);LZMA.decompress(e,e,i,i.data.length),CTM.restoreMap(t[n].uv,2,r)}},CTM.ReaderMG2.prototype.readAttrMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32(),t[n].name=e.readString();var r=e.readFloat32();e.readInt32();var i=new CTM.InterleavedStream(t[n].attr,4);LZMA.decompress(e,e,i,i.data.length),CTM.restoreMap(t[n].attr,4,r)}},CTM.restoreIndices=function(e,t){var n=3;t>0&&(e[2]+=e[0]);for(;n<t;n+=3)e[n]+=e[n-3],e[n]===e[n-3]?e[n+1]+=e[n-2]:e[n+1]+=e[n],e[n+2]+=e[n]},CTM.restoreGridIndices=function(e,t){var n=1;for(;n<t;++n)e[n]+=e[n-1]},CTM.restoreVertices=function(e,t,n,r){var i,s,o,u,a,f=new Uint32Array(e.buffer,e.byteOffset,e.length),l=t.divx,c=l*t.divy,h=2147483647,p=0,d=0,v=0,m=n.length;for(;d<m;v+=3)o=i=n[d++],a=~~(o/c),o-=~~(a*c),u=~~(o/l),o-=~~(u*l),s=f[v],i===h&&(s+=p),e[v]=t.lowerBoundx+o*t.sizex+r*s,e[v+1]=t.lowerBoundy+u*t.sizey+r*f[v+1],e[v+2]=t.lowerBoundz+a*t.sizez+r*f[v+2],h=i,p=s},CTM.restoreNormals=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p=new Uint32Array(e.buffer,e.byteOffset,e.length),d=0,v=e.length,m=1.5707963267948966;for(;d<v;d+=3)r=p[d]*n,i=p[d+1],i===0?(e[d]=t[d]*r,e[d+1]=t[d+1]*r,e[d+2]=t[d+2]*r):(i<=4?s=(p[d+2]-2)*m:s=(p[d+2]*4/i-2)*m,i*=n*m,o=r*Math.sin(i),u=o*Math.cos(s),a=o*Math.sin(s),f=r*Math.cos(i),c=t[d+1],l=t[d]-t[d+2],h=Math.sqrt(2*c*c+l*l),h>1e-20&&(l/=h,c/=h),e[d]=t[d]*f+(t[d+1]*c-t[d+2]*l)*a-c*u,e[d+1]=t[d+1]*f-(t[d+2]+t[d])*c*a+l*u,e[d+2]=t[d+2]*f+(t[d]*l+t[d+1]*c)*a+c*u)},CTM.restoreMap=function(e,t,n){var r,i,s=new Uint32Array(e.buffer,e.byteOffset,e.length),o=0,u,a=e.length;for(;o<t;++o){r=0;for(u=o;u<a;u+=t)i=s[u],r+=i&1?-(i+1>>1):i>>1,e[u]=r*n}},CTM.calcSmoothNormals=function(e,t){var n=new Float32Array(t.length),r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;for(m=0,g=e.length;m<g;)r=e[m++]*3,i=e[m++]*3,s=e[m++]*3,f=t[i]-t[r],h=t[s]-t[r],l=t[i+1]-t[r+1],p=t[s+1]-t[r+1],c=t[i+2]-t[r+2],d=t[s+2]-t[r+2],o=l*d-c*p,u=c*h-f*d,a=f*p-l*h,v=Math.sqrt(o*o+u*u+a*a),v>1e-10&&(o/=v,u/=v,a/=v),n[r]+=o,n[r+1]+=u,n[r+2]+=a,n[i]+=o,n[i+1]+=u,n[i+2]+=a,n[s]+=o,n[s+1]+=u,n[s+2]+=a;for(m=0,g=n.length;m<g;m+=3)v=Math.sqrt(n[m]*n[m]+n[m+1]*n[m+1]+n[m+2]*n[m+2]),v>1e-10&&(n[m]/=v,n[m+1]/=v,n[m+2]/=v);return n},CTM.isLittleEndian=function(){var e=new ArrayBuffer(2),t=new Uint8Array(e),n=new Uint16Array(e);return t[0]=1,n[0]===1}(),CTM.InterleavedStream=function(e,t){this.data=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.offset=CTM.isLittleEndian?3:0,this.count=t*4,this.len=this.data.length},CTM.InterleavedStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count&&(this.offset-=this.count+(CTM.isLittleEndian?1:-1)))},CTM.Stream=function(e){this.data=e,this.offset=0},CTM.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23),CTM.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126),CTM.Stream.prototype.readByte=function(){return this.data.charCodeAt(this.offset++)&255},CTM.Stream.prototype.readInt32=function(){var e=this.readByte();return e|=this.readByte()<<8,e|=this.readByte()<<16,e|this.readByte()<<24},CTM.Stream.prototype.readFloat32=function(){var e=this.readByte();e+=this.readByte()<<8;var t=this.readByte(),n=this.readByte();e+=(t&127)<<16;var r=(n&127)<<1|(t&128)>>>7,i=n&128?-1:1;return r===255?e!==0?NaN:i*Infinity:r>0?i*(1+e*this.TWO_POW_MINUS23)*Math.pow(2,r-127):e!==0?i*e*this.TWO_POW_MINUS126:i*0},CTM.Stream.prototype.readString=function(){var e=this.readInt32();return this.offset+=e,this.data.substr(this.offset-e,e)},CTM.Stream.prototype.readArrayInt32=function(e){var t=0,n=e.length;while(t<n)e[t++]=this.readInt32();return e},CTM.Stream.prototype.readArrayFloat32=function(e){var t=0,n=e.length;while(t<n)e[t++]=this.readFloat32();return e};