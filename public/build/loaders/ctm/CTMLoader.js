THREE.CTMLoader=function(e){THREE.Loader.call(this,e)},THREE.CTMLoader.prototype=Object.create(THREE.Loader.prototype),THREE.CTMLoader.prototype.loadParts=function(e,t,n){var r=this,i=new XMLHttpRequest,s=n.basePath?n.basePath:this.extractUrlBase(e);i.onreadystatechange=function(){if(i.readyState===4)if(i.status===200||i.status===0){var e=JSON.parse(i.responseText),o=[],u=[],a=0;function f(n){a+=1,u.push(n),a===e.offsets.length&&t(u,o)}for(var l=0;l<e.materials.length;l++)o[l]=THREE.Loader.prototype.createMaterial(e.materials[l],s);var c=s+e.data,h={useWorker:n.useWorker,useBuffers:n.useBuffers,offsets:e.offsets};r.load(c,f,h)}},i.open("GET",e,!0),i.overrideMimeType&&i.overrideMimeType("text/plain; charset=x-user-defined"),i.setRequestHeader("Content-Type","text/plain"),i.send(null)},THREE.CTMLoader.prototype.load=function(e,t,n){var r=this,i=n.offsets!==undefined?n.offsets:[0],s=n.useBuffers!==undefined?n.useBuffers:!0,o=new XMLHttpRequest,u=null,a=0;o.onreadystatechange=function(){if(o.readyState===4)if(o.status===200||o.status===0){var f=o.responseText;if(n.useWorker){var l=new Worker("js/loaders/ctm/CTMWorker.js");l.onmessage=function(e){var n=e.data;for(var i=0;i<n.length;i++){var o=n[i];s?r.createModelBuffers(o,t):r.createModelClassic(o,t)}},l.postMessage({data:f,offsets:i})}else for(var c=0;c<i.length;c++){var h=new CTM.Stream(f);h.offset=i[c];var p=new CTM.File(h);s?r.createModelBuffers(p,t):r.createModelClassic(p,t)}}else console.error("Couldn't load ["+e+"] ["+o.status+"]");else o.readyState===3?u&&(a===0&&(a=o.getResponseHeader("Content-Length")),u({total:a,loaded:o.responseText.length})):o.readyState===2&&(a=o.getResponseHeader("Content-Length"))},o.overrideMimeType("text/plain; charset=x-user-defined"),o.open("GET",e,!0),o.send(null)},THREE.CTMLoader.prototype.createModelBuffers=function(e,t){var n=function(){var t=this,n=!0;t.materials=[],THREE.BufferGeometry.call(this);var r=e.body.indices,i=e.body.vertices,s=e.body.normals,o,u;e.body.uvMaps!==undefined&&e.body.uvMaps.length>0&&(o=e.body.uvMaps[0].uv),e.body.attrMaps!==undefined&&e.body.attrMaps.length>0&&e.body.attrMaps[0].name==="Color"&&(u=e.body.attrMaps[0].attr);if(n){var a=new Uint32Array(r.length),f=new Float32Array(i.length),l,c,h;s&&(l=new Float32Array(s.length)),o&&(c=new Float32Array(o.length)),u&&(h=new Float32Array(u.length));var p={},d=0;function v(e){if(p[e]===undefined){p[e]=d;var t=e*3,n=e*3+1,r=e*3+2,a=d*3,v=d*3+1,m=d*3+2;f[a]=i[t],f[v]=i[n],f[m]=i[r],s&&(l[a]=s[t],l[v]=s[n],l[m]=s[r]),o&&(c[d*2]=o[e*2],c[d*2+1]=o[e*2+1]),u&&(h[d*4]=u[e*4],h[d*4+1]=u[e*4+1],h[d*4+2]=u[e*4+2],h[d*4+3]=u[e*4+3]),d+=1}}var m,g,y;for(var b=0;b<r.length;b+=3)m=r[b],g=r[b+1],y=r[b+2],v(m),v(g),v(y),a[b]=p[m],a[b+1]=p[g],a[b+2]=p[y];r=a,i=f,s&&(s=l),o&&(o=c),u&&(u=h)}t.offsets=[];var w=r,E=0,S=i.length,x=0,T=S;for(var b=0;b<w.length;){for(var N=0;N<3;++N){var C=w[b++];C<S&&(S=C),C>x&&(x=C)}if(x-S>65535){b-=3;for(var k=E;k<b;++k)w[k]-=T;t.offsets.push({start:E,count:b-E,index:T}),E=b,S=i.length,x=0}T=S}for(var k=E;k<b;++k)w[k]-=T;t.offsets.push({start:E,count:b-E,index:T});var L=new Uint16Array(r),A=t.attributes;A.index={itemSize:1,array:L,numItems:L.length},A.position={itemSize:3,array:i,numItems:i.length},s!==undefined&&(A.normal={itemSize:3,array:s,numItems:s.length}),o!==undefined&&(A.uv={itemSize:2,array:o,numItems:o.length}),u!==undefined&&(A.color={itemSize:4,array:u,numItems:u.length})};n.prototype=Object.create(THREE.BufferGeometry.prototype);var r=new n;r.attributes.normal===undefined&&r.computeVertexNormals(),t(r)},THREE.CTMLoader.prototype.createModelClassic=function(e,t){function r(e,t,n,r){e.vertices.push(new THREE.Vector3(t,n,r))}function i(e,t,n,r,i){var s=new THREE.Face3(t,n,r,null,null,i);return e.faces.push(s),s}function s(e,t,n,r,i,s,o,u,a){var f=t[o*3],l=t[o*3+1],c=t[o*3+2],h=t[u*3],p=t[u*3+1],d=t[u*3+2],v=t[a*3],m=t[a*3+1],g=t[a*3+2],y=new THREE.Vector3(f,l,c),b=new THREE.Vector3(h,p,d),w=new THREE.Vector3(v,m,g),E=new THREE.Face3(n,r,i,[y,b,w],null,s);return e.faces.push(E),E}function o(e,t,n,r,i,s,o){var u=[];u.push(new THREE.Vector2(t,n)),u.push(new THREE.Vector2(r,i)),u.push(new THREE.Vector2(s,o)),e.push(u)}var n=function(){function h(e){var n,i,s,o,u=e.length;for(o=0;o<u;o+=3)n=e[o],i=e[o+1],s=e[o+2],r(t,n,i,s)}function p(e){var t,r,i,s,o=e.length;for(s=0;s<o;s+=3)t=e[s],r=e[s+1],i=e[s+2],n.push(t,r,i)}function d(e){var t,n,r,i,s,o=e.length;for(s=0;s<o;s+=4){t=e[s],n=e[s+1],r=e[s+2],i=e[s+3];var u=new THREE.Color;u.setRGB(t,n,r),a.push(u)}}function v(e){var t,n,r,i=e.length;for(r=0;r<i;r+=2)t=e[r],n=e[r+1],u.push(t,n)}function m(e){var r,h,p,d,v,m,g,y,b,w,E,S,x=e.length;w=0;for(S=0;S<x;S+=3)r=e[S],h=e[S+1],p=e[S+2],f?E=s(t,n,r,h,p,w,r,h,p):E=i(t,r,h,p,w),c&&(E.vertexColors[0]=a[r],E.vertexColors[1]=a[h],E.vertexColors[2]=a[p]),l&&(d=u[r*2],v=u[r*2+1],m=u[h*2],g=u[h*2+1],y=u[p*2],b=u[p*2+1],o(t.faceVertexUvs[0],d,v,m,g,y,b))}var t=this;t.materials=[],THREE.Geometry.call(this);var n=[],u=[],a=[];h(e.body.vertices),e.body.normals!==undefined&&p(e.body.normals),e.body.uvMaps!==undefined&&e.body.uvMaps.length>0&&v(e.body.uvMaps[0].uv),e.body.attrMaps!==undefined&&e.body.attrMaps.length>0&&e.body.attrMaps[0].name==="Color"&&d(e.body.attrMaps[0].attr);var f=n.length>0?!0:!1,l=u.length>0?!0:!1,c=a.length>0?!0:!1;m(e.body.indices),this.computeCentroids(),this.computeFaceNormals()};n.prototype=Object.create(THREE.Geometry.prototype),t(new n)};